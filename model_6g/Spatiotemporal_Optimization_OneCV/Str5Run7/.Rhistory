true_mean <- eval(parse(text = stmt))[,-1]
colnames(true_mean) <- sci_names
##################################################
####   Save Data
##################################################
save(list = c("frame", "frame_raw", "true_mean", "ns", "NTime", "N",
"sci_names", "samples", "nboats", "Niters"),
file = paste0(github_dir, "model_", VAST_model,
"/optimization_data.RData"))
###############################################################################
## Project:       Data synthesis for stratified survey optimization
## Author:        Zack Oyafuso (zack.oyafuso@noaa.gov)
## Description:   Create dataset used for all optimization runs based on a
##                Gulf of Alaska Multispecies Groundfish VAST Spatiotemporal
##                Operating Model specified on line 24
##
##                Calculate true mean density across years for each species
##
##                Set up other constants used in downstream processes
###############################################################################
##################################################
####  Import required packages
##################################################
library(SamplingStrata)
##################################################
####    Set up directories
##################################################
rm(list = ls())
which_machine <- c("Zack_MAC" = 1, "Zack_PC" = 2, "Zack_GI_PC" = 3)[3]
VAST_model <- "6g"
github_dir <- paste0(c("/Users/zackoyafuso/Documents",
"C:/Users/Zack Oyafuso/Documents",
"C:/Users/zack.oyafuso/Work")[which_machine],
"/GitHub/Optimal_Allocation_GoA_Manuscript/")
VAST_dir <- paste0(c("/Users/zackoyafuso/Google Drive/GOA_",
"C:/Users/Zack Oyafuso/Google Drive/GOA_",
"C:/Users/zack.oyafuso/Desktop/")[which_machine],
"VAST_Runs/VAST_output", VAST_model, "/")
##################################################
####   Set up Result Directories
##################################################
result_dir <- paste0(github_dir, "model_", VAST_model, "/")
if(!dir.exists(result_dir)){
dir.create(result_dir)
dir.create(paste0(result_dir, "Spatial_Optimization_OneCV/"))
dir.create(paste0(result_dir, "Spatiotemporal_Optimization_OneCV/") )
dir.create(paste0(result_dir, "Spatiotemporal_Optimization_SppSpecificCV/") )
}
##################################################
####   Load VAST output and bathymetry data
##################################################
load(paste0(VAST_dir, "/fit.RData"))
load(paste0(github_dir, "data/Extrapolation_depths.RData"))
spp_df <- read.csv(file = paste0(github_dir, "data/spp_df.csv"),
check.names = F,
header = T,
row.names = "modelno")
##################################################
####   Constants
##################################################
## Index years that had data
# Year_Set <- seq(min(fit$data_frame[,"t_i"]),
#                max(fit$data_frame[,"t_i"]))
# Years2Include <- which( Year_Set %in% sort(unique(fit$data_frame[,"t_i"])))
Year_Set <- 1996:2019
Years2Include <- c(1,  4,  8, 10, 12, 14, 16, 18, 20, 22, 24)
NTime <- length(Years2Include)
#Number of sampling grids
N <- nrow(Extrapolation_depths)
#Species names
which_spp_idx <- unlist(spp_df[VAST_model,])
sci_names <- sort( names(spp_df)[which_spp_idx] )
ns <- length(sci_names)
#Sample sizes
samples <- c(280, 550, 820)
nboats <- length(samples)
#Number of times to simulate survey
Niters <- 1000
stratas <- c(5, 10, 15, 20, 30, 60)
NStrata <- length(stratas)
##################################################
####   Create the data inputs to SamplingStrata
##################################################
df <- df_raw <- NULL
##################################################
####   Mean density across years
##################################################
df <- cbind(
data.frame(Domain = 1,
x = 1:N,
lat = Extrapolation_depths$N_km,
lon = Extrapolation_depths$E_km - min(Extrapolation_depths$E_km),
depth = Extrapolation_depths$depth),
#Mean Density across years
apply(X = fit$Report$D_gcy[,,Years2Include],
MARGIN = 1:2,
FUN = mean )
)
names(df)[-(1:5)] <- gsub(x = sci_names, pattern = " ", replacement = "_")
frame <- SamplingStrata::buildFrameDF(df = df,
id = "x",
X = c("depth", "lon"),
Y = gsub(x = sci_names,
pattern = " ",
replacement = "_"),
domainvalue = "Domain")
##################################################
####   Predicted density for each observed year and cell
##################################################
for (iT in 1:NTime) {
df_raw <- rbind(df_raw, cbind(
data.frame(Domain = 1,
x = 1:N,
year = iT,
lat = Extrapolation_depths$N_km,
lon = Extrapolation_depths$E_km - min(Extrapolation_depths$E_km),
depth = Extrapolation_depths$depth),
fit$Report$D_gcy[,,Years2Include[iT]] )
)
}
names(df_raw)[-(1:6)] <- gsub(x = sci_names, pattern = " ", replacement = "_")
frame_raw <- SamplingStrata::buildFrameDF(df = df_raw,
id = "x",
X = c("depth", "lon"),
Y = gsub(x = sci_names,
pattern = " ",
replacement = "_"),
domainvalue = "Domain")
##################################################
####   Calculate "true" mean density
##################################################
frame_raw$year <- rep(x = 1:NTime, each = N)
stmt <- paste0("aggregate(cbind(",
paste0("Y", 1:(ns-1), sep = ",", collapse = ""), "Y",ns,
") ~ year, data = frame_raw, FUN = mean)")
true_mean <- eval(parse(text = stmt))[,-1]
colnames(true_mean) <- sci_names
##################################################
####   Save Data
##################################################
save(list = c("frame", "frame_raw", "true_mean", "ns", "NTime", "N",
"sci_names", "samples", "nboats", "Niters"),
file = paste0(github_dir, "model_", VAST_model,
"/optimization_data.RData"))
###############################################################################
## Project:       Spatiotemporal Survey Optimization
## Author:        Zack Oyafuso (zack.oyafuso@noaa.gov)
## Description:   Conduct SamplingStrata R package multispecies stratified
##                survey optimization
###############################################################################
rm(list = ls())
##################################################
####    Import required packages
##################################################
library(sp)
library(RColorBrewer)
library(raster)
##################################################
####   Set up directories
####
####   Set up some constants of the optimization
####   OneCV: one CV applied to all species
####   SppSpecificCV: species-specific CV
####
####   Set up type of variance used
####   Spatial_Optimization: optimizing using spatial variance only
####   Spatiotemporal_Optimization: optimizing using spatiotemporal variance
##################################################
which_machine <- c("Zack_MAC" = 1, "Zack_PC" = 2, "Zack_GI_PC" = 3)[3]
VAST_model <- "6g"
SamplingStrata_dir <- paste0(c("/Users/zackoyafuso/",
"C:/Users/Zack Oyafuso/",
"C:/Users/zack.oyafuso/")[which_machine],
"Downloads/SamplingStrata-master/R")
which_CV_method = c("OneCV", "SppSpecificCV")[1]
which_variance = c("Spatial_Optimization", "Spatiotemporal_Optimization")[2]
github_dir <- paste0(c("/Users/zackoyafuso/Documents",
"C:/Users/Zack Oyafuso/Documents",
"C:/Users/zack.oyafuso/Work")[which_machine],
"/GitHub/Optimal_Allocation_GoA_Manuscript/model_",
VAST_model, "/", which_variance, '_', which_CV_method, '/')
##################################################
####   Load functions from SamplingStrata packages into global environment
####   Load modified buildStrataDF function if using spatiotemporal
####   stratum variance
##################################################
if (which_variance == "Spatiotemporal_Optimization") {
for (ifile in dir(SamplingStrata_dir, full.names = T)) source(ifile)
source(paste0(dirname(dirname(github_dir)),
"/modified_functions/buildStrataDF_Zack.R"))
}
if (which_variance == "Spatial_Optimization") {
library(SamplingStrata)
}
##################################################
####   Load Data
##################################################
load(paste0(dirname(github_dir), "/optimization_data.RData"))
load(paste0(dirname(dirname(github_dir)), "/data/Extrapolation_depths.RData"))
source('~/GitHub/Optimal_Allocation_GoA_Manuscript/optimization_data.R', echo=TRUE)
###############################################################################
## Project:       Spatiotemporal Survey Optimization
## Author:        Zack Oyafuso (zack.oyafuso@noaa.gov)
## Description:   Conduct SamplingStrata R package multispecies stratified
##                survey optimization
###############################################################################
rm(list = ls())
##################################################
####    Import required packages
##################################################
library(sp)
library(RColorBrewer)
library(raster)
##################################################
####   Set up directories
####
####   Set up some constants of the optimization
####   OneCV: one CV applied to all species
####   SppSpecificCV: species-specific CV
####
####   Set up type of variance used
####   Spatial_Optimization: optimizing using spatial variance only
####   Spatiotemporal_Optimization: optimizing using spatiotemporal variance
##################################################
which_machine <- c("Zack_MAC" = 1, "Zack_PC" = 2, "Zack_GI_PC" = 3)[3]
VAST_model <- "6g"
SamplingStrata_dir <- paste0(c("/Users/zackoyafuso/",
"C:/Users/Zack Oyafuso/",
"C:/Users/zack.oyafuso/")[which_machine],
"Downloads/SamplingStrata-master/R")
which_CV_method = c("OneCV", "SppSpecificCV")[1]
which_variance = c("Spatial_Optimization", "Spatiotemporal_Optimization")[2]
github_dir <- paste0(c("/Users/zackoyafuso/Documents",
"C:/Users/Zack Oyafuso/Documents",
"C:/Users/zack.oyafuso/Work")[which_machine],
"/GitHub/Optimal_Allocation_GoA_Manuscript/model_",
VAST_model, "/", which_variance, '_', which_CV_method, '/')
##################################################
####   Load functions from SamplingStrata packages into global environment
####   Load modified buildStrataDF function if using spatiotemporal
####   stratum variance
##################################################
if (which_variance == "Spatiotemporal_Optimization") {
for (ifile in dir(SamplingStrata_dir, full.names = T)) source(ifile)
source(paste0(dirname(dirname(github_dir)),
"/modified_functions/buildStrataDF_Zack.R"))
}
if (which_variance == "Spatial_Optimization") {
library(SamplingStrata)
}
##################################################
####   Load Data
##################################################
load(paste0(dirname(github_dir), "/optimization_data.RData"))
load(paste0(dirname(dirname(github_dir)), "/data/Extrapolation_depths.RData"))
stratas <- c(5,10,15,20,30,60)
##################################################
####  lower CV threshold
####  Set to 0.10 for all scenarios (naive assumption)
##################################################
threshold <- matrix(0.1, nrow = ns, ncol = nboats)
##################################################
####   Run optimization
##################################################
par(mfrow = c(6,6), mar = c(2,2,0,0))
istrata = 1
temp_strata <- stratas[istrata]
##Initial Condition
Run <- 1
isample <- 1
current_n <- 0
##Initial Upper CV constraints
CV_constraints = rep(
x = ifelse(which_variance == "Spatial_Optimization", 0.2, 0.4),
times = ns)
#How much the CV should be reduced by
creep_rate = ifelse(which_variance == "Spatial_Optimization", 0.01, 0.02)
#Create CV dataframe
cv <- list()
for (spp in 1:ns) cv[[paste0("CV", spp)]] <- as.numeric(CV_constraints[spp])
cv[["DOM"]] <- 1
cv[["domainvalue"]] <- 1
cv <- as.data.frame(cv)
cv
creep_rate
CV_constraints
github_dir
while(current_n <= 820){ #Run until you reach 820 samples
#Set wd for output files, create a directory if it doesn"t exist yet
temp_dir = paste0(github_dir, "Str", temp_strata, "Run",Run)
if(!dir.exists(temp_dir)) dir.create(temp_dir)
setwd(temp_dir)
#Run optimization
solution <- optimStrata(method = "continuous",
errors = cv,
framesamp = frame,
iter = 200,
pops = 30,
elitism_rate = 0.1,
mut_chance = 1 / (temp_strata + 1),
nStrata = temp_strata,
showPlot = T,
parallel = F,
writeFiles = T)
sum_stats <- summaryStrata(solution$framenew,
solution$aggr_strata,
progress=FALSE)
#Plot Solution
goa <- SpatialPointsDataFrame(
coords = Extrapolation_depths[,c("E_km", "N_km")],
data = data.frame(Str_no = solution$framenew$STRATO) )
goa_ras <- raster(goa, resolution = 5)
goa_ras <- rasterize(x = goa, y = goa_ras, field = "Str_no")
png(filename = "solution.png", width = 5, height = 5, units = "in",
res = 500)
plot(goa_ras, axes = F,
col = terrain.colors(temp_strata)[sample(temp_strata)])
dev.off()
#Save Output
CV_constraints <- expected_CV(strata = solution$aggr_strata)
current_n <- sum(sum_stats$Allocation)
isample <- ifelse(current_n < 280, 1, #1 boat
ifelse(current_n < 550, 2, #2 boat
3)) #3 boat
result_list <- list(solution = solution,
sum_stats = sum_stats,
CV_constraints = CV_constraints,
n = current_n)
save(list = "result_list", file = "result_list.RData")
#Set up next run by changing upper CV constraints and reduce CV constraints
#by the creep rateabsolutely
Run <- Run + 1
CV_constraints <- CV_constraints - creep_rate
#Apply lower threshold: if CV is lower than the threshold, set CV to
#to the lower theshold
for (ispp in 1:ns) {
CV_constraints[ispp] <-
ifelse(CV_constraints[ispp]<threshold[ispp, isample],
threshold[ispp, isample],
CV_constraints[ispp])
}
#Create CV dataframe in the formmat of SamplingStrata
cv <- list()
for (spp in 1:ns) cv[[paste0("CV", spp)]] <- as.numeric(CV_constraints[spp])
cv[["DOM"]] <- 1
cv[["domainvalue"]] <- 1
cv <- as.data.frame(cv)
}
for (istrata in 1) {
temp_strata <- stratas[istrata]
##Initial Condition
Run <- 1
isample <- 1
current_n <- 0
##Initial Upper CV constraints
CV_constraints = rep(
x = ifelse(which_variance == "Spatial_Optimization", 0.2, 0.35),
times = ns)
#How much the CV should be reduced by
creep_rate = ifelse(which_variance == "Spatial_Optimization", 0.01, 0.02)
#Create CV dataframe
cv <- list()
for (spp in 1:ns) cv[[paste0("CV", spp)]] <- as.numeric(CV_constraints[spp])
cv[["DOM"]] <- 1
cv[["domainvalue"]] <- 1
cv <- as.data.frame(cv)
while(current_n <= 820){ #Run until you reach 820 samples
#Set wd for output files, create a directory if it doesn"t exist yet
temp_dir = paste0(github_dir, "Str", temp_strata, "Run",Run)
if(!dir.exists(temp_dir)) dir.create(temp_dir)
setwd(temp_dir)
#Run optimization
solution <- optimStrata(method = "continuous",
errors = cv,
framesamp = frame,
iter = 200,
pops = 30,
elitism_rate = 0.1,
mut_chance = 1 / (temp_strata + 1),
nStrata = temp_strata,
showPlot = T,
parallel = F,
writeFiles = T)
sum_stats <- summaryStrata(solution$framenew,
solution$aggr_strata,
progress=FALSE)
#Plot Solution
goa <- SpatialPointsDataFrame(
coords = Extrapolation_depths[,c("E_km", "N_km")],
data = data.frame(Str_no = solution$framenew$STRATO) )
goa_ras <- raster(goa, resolution = 5)
goa_ras <- rasterize(x = goa, y = goa_ras, field = "Str_no")
png(filename = "solution.png", width = 5, height = 5, units = "in",
res = 500)
plot(goa_ras, axes = F,
col = terrain.colors(temp_strata)[sample(temp_strata)])
dev.off()
#Save Output
CV_constraints <- expected_CV(strata = solution$aggr_strata)
current_n <- sum(sum_stats$Allocation)
isample <- ifelse(current_n < 280, 1, #1 boat
ifelse(current_n < 550, 2, #2 boat
3)) #3 boat
result_list <- list(solution = solution,
sum_stats = sum_stats,
CV_constraints = CV_constraints,
n = current_n)
save(list = "result_list", file = "result_list.RData")
#Set up next run by changing upper CV constraints and reduce CV constraints
#by the creep rateabsolutely
Run <- Run + 1
CV_constraints <- CV_constraints - creep_rate
#Apply lower threshold: if CV is lower than the threshold, set CV to
#to the lower theshold
for (ispp in 1:ns) {
CV_constraints[ispp] <-
ifelse(CV_constraints[ispp]<threshold[ispp, isample],
threshold[ispp, isample],
CV_constraints[ispp])
}
#Create CV dataframe in the formmat of SamplingStrata
cv <- list()
for (spp in 1:ns) cv[[paste0("CV", spp)]] <- as.numeric(CV_constraints[spp])
cv[["DOM"]] <- 1
cv[["domainvalue"]] <- 1
cv <- as.data.frame(cv)
}
}
##################################################
####   Run optimization
##################################################
par(mfrow = c(6,6), mar = c(2,2,0,0))
for (istrata in 1) {
temp_strata <- stratas[istrata]
##Initial Condition
Run <- 1
isample <- 1
current_n <- 0
##Initial Upper CV constraints
CV_constraints = rep(
x = ifelse(which_variance == "Spatial_Optimization", 0.2, 0.3),
times = ns)
#How much the CV should be reduced by
creep_rate = ifelse(which_variance == "Spatial_Optimization", 0.01, 0.02)
#Create CV dataframe
cv <- list()
for (spp in 1:ns) cv[[paste0("CV", spp)]] <- as.numeric(CV_constraints[spp])
cv[["DOM"]] <- 1
cv[["domainvalue"]] <- 1
cv <- as.data.frame(cv)
while(current_n <= 820){ #Run until you reach 820 samples
#Set wd for output files, create a directory if it doesn"t exist yet
temp_dir = paste0(github_dir, "Str", temp_strata, "Run",Run)
if(!dir.exists(temp_dir)) dir.create(temp_dir)
setwd(temp_dir)
#Run optimization
solution <- optimStrata(method = "continuous",
errors = cv,
framesamp = frame,
iter = 200,
pops = 30,
elitism_rate = 0.1,
mut_chance = 1 / (temp_strata + 1),
nStrata = temp_strata,
showPlot = T,
parallel = F,
writeFiles = T)
sum_stats <- summaryStrata(solution$framenew,
solution$aggr_strata,
progress=FALSE)
#Plot Solution
goa <- SpatialPointsDataFrame(
coords = Extrapolation_depths[,c("E_km", "N_km")],
data = data.frame(Str_no = solution$framenew$STRATO) )
goa_ras <- raster(goa, resolution = 5)
goa_ras <- rasterize(x = goa, y = goa_ras, field = "Str_no")
png(filename = "solution.png", width = 5, height = 5, units = "in",
res = 500)
plot(goa_ras, axes = F,
col = terrain.colors(temp_strata)[sample(temp_strata)])
dev.off()
#Save Output
CV_constraints <- expected_CV(strata = solution$aggr_strata)
current_n <- sum(sum_stats$Allocation)
isample <- ifelse(current_n < 280, 1, #1 boat
ifelse(current_n < 550, 2, #2 boat
3)) #3 boat
result_list <- list(solution = solution,
sum_stats = sum_stats,
CV_constraints = CV_constraints,
n = current_n)
save(list = "result_list", file = "result_list.RData")
#Set up next run by changing upper CV constraints and reduce CV constraints
#by the creep rateabsolutely
Run <- Run + 1
CV_constraints <- CV_constraints - creep_rate
#Apply lower threshold: if CV is lower than the threshold, set CV to
#to the lower theshold
for (ispp in 1:ns) {
CV_constraints[ispp] <-
ifelse(CV_constraints[ispp]<threshold[ispp, isample],
threshold[ispp, isample],
CV_constraints[ispp])
}
#Create CV dataframe in the formmat of SamplingStrata
cv <- list()
for (spp in 1:ns) cv[[paste0("CV", spp)]] <- as.numeric(CV_constraints[spp])
cv[["DOM"]] <- 1
cv[["domainvalue"]] <- 1
cv <- as.data.frame(cv)
}
}
